#!/bin/bash

#--------------------------------------------------------------------#
# This script converts the .dot files generated by TRACER into pdf
# format and then opens them with a pdf reader.  
#
# If you do not see any dot file, then you should add the option
# -DGRAPHVIZ_USE in src/clpr/Makefile.
#--------------------------------------------------------------------#

DOT_CMMD=dot
FILES="./*.dot"
PDFREADER="acroread"   # default pdf reader

usage() {
cat <<EOF
usage: $0 
  convert and open dot files in current directory

usage: $0 options
  -help              print this message
  -pdf-reader value  options: acroread | xpdf | evince | okular                    
  -dot-dir    PATH   convert and open dot files located in directory dir
EOF
}

# is $1 installed?
_have() { which "$1" &>/dev/null; }

# function to open the file with any available pdf reader
function open_with_available_pdfreader {    
    if _have acroread; then
	acroread $1 &	    
    else
 	if _have xpdf; then
	    xpdf $1 &
	else
	    if _have evince; then
		evince $1 &            
	    else
		if _have okular; then
		    okular $1 & 
		else
		    echo "not pdf reader found"
		    exit 0
		    
		fi
	    fi
	fi
    fi    
}

function check_valid_pdf_reader {
    if [ $1 != "acroread" ] && [ $1 != "xpdf" ] && [ $1 != "evince" ]  && [ $1 != "okular" ]; then
	echo "allfigs2pdf: warning: the pdf reader $1 may not be installed."
    fi			
}

if ! _have $DOT_CMMD;  
then
    echo "allfigs2pdf: command \"$1\" is not found."
    echo "allfigs2pdf: if you have not installed \"$1\" download graphviz."
    echo "allfigs2pdf: otherwise, add the directory where \"$1\" is located to \$PATH."
    exit 0
fi


# process args
while [ "$1" != "" ]; do
  case "$1" in
    -help)
      usage
      exit 0
      ;;
    -pdf-reader)
      shift
      check_valid_pdf_reader $1
      PDFREADER=$1
     ;;          
    -dot-dir)
      shift
      FILES0="${1%\/*}"
      FILES="${FILES0}/*.dot"
     ;;          
    *)
      echo "unknown arg: $1"
      usage
      exit 2
      ;;
  esac
  shift
done

#--------------------------------------------------------------------#
# Any .dot, translate it to .pdf
#--------------------------------------------------------------------#
for file in $FILES ; do
    basename=${file%.dot}
    pdffile=$basename.pdf

    if  [ -f $file ] ; then
	if [ ! -f $pdffile -o \( $file -nt $pdffile \) ] ; then
            echo Graphviz converting $file to $pdffile ...
            $DOT_CMMD -Tpdf  $file -o $pdffile
            echo Opening $pdffile ...
            # Here we try to open the pdf file with up to four 
            # different readers
	    if _have $PDFREADER; then
		$PDFREADER $pdffile &	    
	    else
		open_with_available_pdfreader $pdffile
	    fi
	fi
    fi
done







